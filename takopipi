#!/bin/bash
set -e

if [ -z "${1:-}" ]
then
  echo "usage: takopipi <instance>"
  echo "  e.g. takopipi mybot"
  exit 1
fi

INSTANCE="$1"
CONFIG="/srv/app/cfg/takopipi_${INSTANCE}.toml"

if [ ! -f "$CONFIG" ]
then
  echo "config not found: $CONFIG"
  exit 1
fi

mkdir -p /root/.takopi
cp "$CONFIG" /root/.takopi/takopi.toml

# auto-discover web apps from /web
config=/root/.takopi/takopi.toml
sed -i '/^\[projects\./,$d' "$config"

# /web root as project "web"
if [ -d /web ]
then
  ln -sf /srv/app/cfg/CLAUDE.md /web/CLAUDE.md
  cat >> "$config" <<EOF

[projects.web]
path = "/web"
default_engine = "claude"
EOF
fi

# each subdir as its own project
for app in /web/*/
do
  [ -d "$app" ] || continue
  name=$(basename "$app")
  [ "$name" = "node_modules" ] && continue
  ln -sf /srv/app/cfg/CLAUDE.md "$app/CLAUDE.md"

  cat >> "$config" <<EOF

[projects.$name]
path = "$app"
default_engine = "claude"
EOF
done

rm -f /root/.takopi/takopi.lock

# --- run both ---
takopi claude &
TAKOPI=$!

mkdir -p /srv/app/tmp

(while true
do
  npx vite --host 0.0.0.0 --port 49165 &
  echo $! > /srv/app/tmp/vite.pid
  wait $!
  sleep 1
done) &
VITE=$!

trap 'kill $TAKOPI $VITE 2>/dev/null; wait' INT TERM
wait $TAKOPI
kill $VITE 2>/dev/null
wait
