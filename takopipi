#!/bin/bash
set -e

# --- create subcommand ---
if [ "${1:-}" = "create" ]
then
  NAME="${2:-}"
  if [ -z "$NAME" ]
  then
    echo "usage: takopipi create <name>"
    exit 1
  fi
  DEST="/cfg/${NAME}"
  if [ -d "$DEST" ]
  then
    echo "already exists: $DEST"
    exit 1
  fi
  SEED="/srv/app/seed/example"
  [ -d "$SEED" ] || SEED="/cfg/example"
  if [ ! -d "$SEED" ]
  then
    echo "seed template not found"
    exit 1
  fi
  cp -r "$SEED" "$DEST"
  echo "created: $DEST"

  # seed external data dir for host-mount claude config
  DATA_DIR="/srv/data/takopipi_${NAME}/cfg"
  if [ ! -d "$DATA_DIR" ]
  then
    echo "seeding: $DATA_DIR"
    mkdir -p "$DATA_DIR"

    # copy claude config from instance seed
    if [ -d "$DEST/.claude" ]
    then
      cp -r "$DEST/.claude/." "$DATA_DIR/"
    fi

    # seed global config from assistants repo
    tmp=$(mktemp -d)
    git clone --depth 1 \
      https://github.com/kronael/assistants "$tmp" \
      2>/dev/null
    BASE="$tmp/claude-template/global"
    cp "$BASE/CLAUDE.md" "$DATA_DIR/CLAUDE.md"
    mkdir -p "$DATA_DIR/hooks"
    cp -r "$BASE/hooks/." "$DATA_DIR/hooks/"
    mkdir -p "$DATA_DIR/skills"
    cp -rn "$BASE/skills/." "$DATA_DIR/skills/"
    rm -rf "$tmp"

    # credentials template
    mkdir -p "$DATA_DIR"
    cat > "$DATA_DIR/credentials.json.example" <<CRED
{
  "claudeAiOauth": {
    "accessToken": "",
    "refreshToken": "",
    "expiresAt": 0
  }
}
CRED
    echo "seeded: $DATA_DIR"
  else
    echo "exists: $DATA_DIR (skipping seed)"
  fi

  # generate systemd service file
  SERVICE="$DATA_DIR/../takopipi_${NAME}.service"
  cat > "$SERVICE" <<SVC
[Unit]
Description=takopipi ${NAME}
After=docker.service
Requires=docker.service

[Service]
StartLimitInterval=0
StartLimitBurst=100
RestartSec=1
TimeoutStartSec=infinity
Restart=always

ExecStartPre=-/usr/bin/docker stop %n
ExecStartPre=-/usr/bin/docker rm -f %n
ExecStop=/usr/bin/docker rm -f %n
ExecStart=/usr/bin/docker run -i --rm --name %n \
    --network=host \
    -v /srv/data/takopipi_${NAME}/cfg:/root/.claude \
    -v /srv/data/${NAME}/web:/web \
    takopipi \
    ./takopipi ${NAME} /cfg/takopipi_${NAME}.toml

SyslogIdentifier=takopipi_${NAME}
SyslogFacility=local3

[Install]
WantedBy=default.target
SVC
  echo "generated: $SERVICE"

  echo ""
  echo "next:"
  echo "  1. edit $DEST/takopi.toml  (bot_token, chat_id)"
  echo "  2. copy credentials to $DATA_DIR/credentials.json"
  echo "  3. rebuild: make image"
  echo ""

  read -r -p "install service? [y/N] " answer
  if [ "$answer" = "y" ] || [ "$answer" = "Y" ]
  then
    sudo cp "$SERVICE" /etc/systemd/system/
    sudo systemctl daemon-reload
    sudo systemctl enable "takopipi_${NAME}"
    echo "installed: takopipi_${NAME}"
    echo "start: sudo systemctl start takopipi_${NAME}"
  else
    echo "install manually:"
    echo "  sudo cp $SERVICE /etc/systemd/system/"
    echo "  sudo systemctl daemon-reload"
    echo "  sudo systemctl enable --now takopipi_${NAME}"
  fi
  exit 0
fi

# --- instance run ---
if [ -z "${1:-}" ]
then
  echo "usage: takopipi <instance>"
  echo "       takopipi create <name>"
  exit 1
fi

INSTANCE="$1"

# config: explicit path as $2, or /cfg/<instance>/takopi.toml
CONFIG="${2:-/cfg/${INSTANCE}/takopi.toml}"

if [ ! -f "$CONFIG" ]
then
  echo "config not found: $CONFIG"
  exit 1
fi

mkdir -p /root/.takopi
cp "$CONFIG" /root/.takopi/takopi.toml

# auto-discover web apps from /web
config=/root/.takopi/takopi.toml
sed -i '/^\[projects\./,$d' "$config"

# /web root as project "web"
if [ -d /web ]
then
  cat >> "$config" <<EOF

[projects.web]
path = "/web"
default_engine = "claude"
EOF
fi

# each subdir as its own project
for app in /web/*/
do
  [ -d "$app" ] || continue
  name=$(basename "$app")
  [ "$name" = "node_modules" ] && continue

  cat >> "$config" <<EOF

[projects.$name]
path = "$app"
default_engine = "claude"
EOF
done

rm -f /root/.takopi/takopi.lock

# read vite port from config (default 49165)
VITE_PORT=$(python3 -c "
import tomllib
c = tomllib.load(open('$config', 'rb'))
print(c.get('vite', {}).get('port', 49165))
")

# --- run both ---
takopi claude &
TAKOPI=$!

mkdir -p /srv/app/tmp

(while true
do
  npx vite --host 0.0.0.0 --port "$VITE_PORT" &
  echo $! > /srv/app/tmp/vite.pid
  wait $!
  sleep 1
done) &
VITE=$!

trap 'kill $TAKOPI $VITE 2>/dev/null; wait' INT TERM
wait $TAKOPI
kill $VITE 2>/dev/null
wait
