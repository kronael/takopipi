#!/bin/bash
set -e

# --- create subcommand ---
if [ "${1:-}" = "create" ]
then
  NAME="${2:-}"
  if [ -z "$NAME" ]
  then
    echo "usage: takopipi create <name>"
    exit 1
  fi
  DEST="/cfg/${NAME}"
  if [ -d "$DEST" ]
  then
    echo "already exists: $DEST"
    exit 1
  fi
  SEED="/srv/app/seed/example"
  [ -d "$SEED" ] || SEED="/cfg/example"
  if [ ! -d "$SEED" ]
  then
    echo "seed template not found"
    exit 1
  fi
  cp -r "$SEED" "$DEST"
  echo "created: $DEST"

  # seed external data dir for host-mount claude config
  DATA_DIR="/srv/data/takopipi_${NAME}/cfg"
  if [ ! -d "$DATA_DIR" ]
  then
    echo "seeding: $DATA_DIR"
    mkdir -p "$DATA_DIR"

    # copy claude config from instance seed
    if [ -d "$DEST/.claude" ]
    then
      cp -r "$DEST/.claude/." "$DATA_DIR/"
    fi

    # seed global config from assistants repo
    tmp=$(mktemp -d)
    git clone --depth 1 \
      https://github.com/kronael/assistants "$tmp" \
      2>/dev/null
    BASE="$tmp/claude-template/global"
    cp "$BASE/CLAUDE.md" "$DATA_DIR/CLAUDE.md"
    mkdir -p "$DATA_DIR/hooks"
    cp -r "$BASE/hooks/." "$DATA_DIR/hooks/"
    mkdir -p "$DATA_DIR/skills"
    cp -rn "$BASE/skills/." "$DATA_DIR/skills/"
    rm -rf "$tmp"

    # credentials template
    mkdir -p "$DATA_DIR"
    cat > "$DATA_DIR/credentials.json.example" <<CRED
{
  "claudeAiOauth": {
    "accessToken": "",
    "refreshToken": "",
    "expiresAt": 0
  }
}
CRED
    echo "seeded: $DATA_DIR"
  else
    echo "exists: $DATA_DIR (skipping seed)"
  fi

  echo ""
  echo "next:"
  echo "  1. cp $DEST/takopi.toml /cfg/<server>/takopi_${NAME}.toml"
  echo "  2. edit /cfg/<server>/takopi_${NAME}.toml  (bot_token, chat_id)"
  echo "  3. edit $DEST/.claude/CLAUDE.local.md  (bot context)"
  echo "  4. copy credentials to $DATA_DIR/credentials.json"
  echo "  5. run: takopipi $NAME"
  exit 0
fi

# --- instance run ---
if [ -z "${1:-}" ]
then
  echo "usage: takopipi <instance>"
  echo "       takopipi create <name>"
  exit 1
fi

INSTANCE="$1"

# config: explicit path as $2, or /cfg/<instance>/takopi.toml
CONFIG="${2:-/cfg/${INSTANCE}/takopi.toml}"

if [ ! -f "$CONFIG" ]
then
  echo "config not found: $CONFIG"
  exit 1
fi

mkdir -p /root/.takopi
cp "$CONFIG" /root/.takopi/takopi.toml

# --- seed .claude from instance config ---
CLAUDE_SRC="/cfg/${INSTANCE}/.claude"
mkdir -p /root/.claude

if [ -d "$CLAUDE_SRC" ]
then
  # always overwrite CLAUDE.local.md (takopipi authoritative)
  cp "$CLAUDE_SRC/CLAUDE.local.md" /root/.claude/CLAUDE.local.md \
    2>/dev/null || true

  # seed skills no-overwrite (instance skills win)
  if [ -d "$CLAUDE_SRC/skills" ]
  then
    mkdir -p /root/.claude/skills
    cp -rn "$CLAUDE_SRC/skills/." /root/.claude/skills/
  fi

  # always overwrite output styles (takopipi authoritative)
  if [ -d "$CLAUDE_SRC/output-styles" ]
  then
    mkdir -p /root/.claude/output-styles
    cp -r "$CLAUDE_SRC/output-styles/." /root/.claude/output-styles/
  fi

  # always overwrite settings.json (outputStyle etc)
  [ -f "$CLAUDE_SRC/settings.json" ] && \
    cp "$CLAUDE_SRC/settings.json" /root/.claude/settings.json
fi

# seed from kronael/assistants on first run
if [ ! -f /root/.claude/hooks/local.py ]
then
  tmp=$(mktemp -d)
  git clone --depth 1 https://github.com/kronael/assistants "$tmp"
  BASE="$tmp/claude-template/global"
  cp "$BASE/CLAUDE.md" /root/.claude/CLAUDE.md
  mkdir -p /root/.claude/hooks
  cp -r "$BASE/hooks/." /root/.claude/hooks/
  mkdir -p /root/.claude/skills
  cp -rn "$BASE/skills/." /root/.claude/skills/
  rm -rf "$tmp"
fi

# auto-discover web apps from /web
config=/root/.takopi/takopi.toml
sed -i '/^\[projects\./,$d' "$config"

# /web root as project "web"
if [ -d /web ]
then
  cat >> "$config" <<EOF

[projects.web]
path = "/web"
default_engine = "claude"
EOF
fi

# each subdir as its own project
for app in /web/*/
do
  [ -d "$app" ] || continue
  name=$(basename "$app")
  [ "$name" = "node_modules" ] && continue

  cat >> "$config" <<EOF

[projects.$name]
path = "$app"
default_engine = "claude"
EOF
done

rm -f /root/.takopi/takopi.lock

# read vite port from config (default 49165)
VITE_PORT=$(python3 -c "
import tomllib
c = tomllib.load(open('$config', 'rb'))
print(c.get('vite', {}).get('port', 49165))
")

# --- run both ---
takopi claude &
TAKOPI=$!

mkdir -p /srv/app/tmp

(while true
do
  npx vite --host 0.0.0.0 --port "$VITE_PORT" &
  echo $! > /srv/app/tmp/vite.pid
  wait $!
  sleep 1
done) &
VITE=$!

trap 'kill $TAKOPI $VITE 2>/dev/null; wait' INT TERM
wait $TAKOPI
kill $VITE 2>/dev/null
wait
